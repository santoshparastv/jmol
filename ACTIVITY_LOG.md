## Activity Log

### Guardrail (must-follow)
- **Rule**: Every change to this project (code, docs, configs, assets) must be recorded in this file.
- **Each entry includes**: what changed, why, and the key files touched.
- **Granularity**: one bullet per meaningful change (group tiny related edits together).

### 2026-01-19
- **Fix**: Resolved JSX parser error in `components/OfferLetterForm.tsx` by closing the PF `.form-row` div before starting the next row.
- **Note**: Added this log to avoid "looping" without trace and to record each change clearly.
- **Change**: Removed the ₹1800 PF cap in `lib/salaryCalculator.ts` (PF is now pure 12% of Basic when applicable).
- **Fix**: Travel Allowance note display - Removed default TA value (3000), now only shows in PDF when TA field is actually filled in the form. Updated validation in API route and PDF generator to properly check for empty/null/NaN values.
- **In Progress**: Adding signature image and completing 6-page PDF structure (Letter of Engagement pages 5-6). Need to add missing styles (logoContainer, addressContainer, logo) and signature image constant.
- **Issue**: Getting stuck on large file edits. Breaking down into smaller steps.

### 2026-01-20
- **Fix**: Prevented PDF generation crash by adding missing header/logo styles used on pages 2-4, and made page 1 use the same header layout for consistency. Files: `lib/pdfGenerator.tsx`.
- **Feature**: Added authorised signature image to the PDF using `public/signature.png` and added `public/jobsmato-logo.svg` as the logo source asset (logo remains embedded via data URI for react-pdf reliability). Files: `lib/pdfGenerator.tsx`, `public/signature.png`, `public/jobsmato-logo.svg`.
- **Fix**: Made salary calculation internally consistent by using shared constants for rates (notably bonus rate) so the iterative solve and final output match. Files: `lib/salaryCalculator.ts`.
- **Fix**: Enforced PF mandatory rule server-side for PF=No by validating strict PF-off Basic (<= ₹15,000) and returning a clear 400 error; simplified the form to handle API errors (removed extra pre-check call). Files: `app/api/calculate-salary/route.ts`, `lib/salaryCalculator.ts`, `components/OfferLetterForm.tsx`.
- **Feature**: Added bulk CSV generation page at `/bulk` (client-side parsing + sequential PDF downloads) and linked it from the home page. Files: `app/bulk/page.tsx`, `app/page.tsx`.
- **Feature**: Added true bulk generation: `/api/bulk-generate` generates PDFs server-side and returns a single ZIP download; PDF generator now supports server-side rendering via `renderOfferLetterPDFBuffer()` and accepts a signature data URI for server rendering. Files: `app/api/bulk-generate/route.ts`, `app/bulk/page.tsx`, `lib/pdfGenerator.tsx`.
- **Fix**: Updated PDF letterhead/layout to match the desired SS1 style: added top blue bar, made address blue/right-aligned, and laid out Dear/Date + Ref/Offer ID in two-column rows. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Updated offer letter text to match reference document word-for-word: separated "In addition to this:" to new line, removed space after "1." in Section 1, changed DOJ date format to remove ordinal (20-Jan-2026), updated Travel Allowance note to use colon and "Rs is" format, added line breaks in Sections 7 and 8 to match reference formatting, and changed signature text to "Authorised Signatury" (matching reference). Files: `lib/pdfGenerator.tsx`.
- **Fix/Asset**: Added PNG logo (`public/jobsmato-logo.png`) and updated the PDF to use the PNG logo reliably; applied SS1 header (with top blue bar) and SS2 footer (single-row website/phone/email) consistently across all pages; bulk ZIP API now embeds the PNG as a data URI for server-side PDF rendering. Files: `public/jobsmato-logo.png`, `lib/pdfGenerator.tsx`, `app/api/bulk-generate/route.ts`.
- **Fix**: Updated font sizes and spacing throughout the PDF to match reference screenshots: reduced base font size from 10pt to 9pt, title from 14pt to 12pt, address from 9pt to 8pt, table cells from 8pt to 7.5pt, adjusted page padding from 30 to 40, reduced top bar height from 10 to 8, updated logo size (110x40), adjusted all margins and line heights for better visual match. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Configured Next.js dev server to explicitly use port 3000 and freed up port 3000 by killing the blocking Node process. Files: `package.json`.
- **Fix**: Changed base/default font size from 9pt to 11pt throughout the PDF; proportionally updated related font sizes: title 12→14pt, address 8→9pt, table cells 7.5→9pt, signature 8.5→10pt, and all body text elements to 11pt. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Combined pages 2 and 3 into a single page to reduce white space; Sections 3-7 are now on one page instead of being split across two pages. Files: `lib/pdfGenerator.tsx`.
- **Feature**: Created comprehensive state-wise tax mappings system: extracted Professional Tax slab rates from https://saral.pro/blogs/professional-tax-slab-rates-in-different-states/ and implemented slab-based calculation functions; created `lib/stateTaxMappings.ts` with Professional Tax, LWF, and ESIC configurations; updated `lib/salaryCalculator.ts` to use the new mapping functions for accurate state-wise calculations. Professional Tax now supports slab-based calculations (e.g., Maharashtra: ₹0/175/200 based on gross, Karnataka: ₹200 with ₹300 in February). LWF and ESIC data structures are ready for extraction from PDFs. Files: `lib/stateTaxMappings.ts`, `lib/salaryCalculator.ts`, `scripts/extract-pdf-data.mjs`, `scripts/README_EXTRACT_DATA.md`.
- **Feature**: Created PDF extraction scripts using pdf-parse library: `scripts/extract-pdf-text.cjs` and `scripts/extract-pdf-simple.mjs`. The PDFs (LWF.pdf and ESIC State Wise.pdf) appear to be image-based, so text extraction is limited. Created helper script `scripts/extract-docx-data.cjs` with instructions for manual data extraction. The .docx files can be opened and data copied manually to update `lib/stateTaxMappings.ts`. Files: `scripts/extract-pdf-text.cjs`, `scripts/extract-pdf-simple.mjs`, `scripts/extract-docx-data.cjs`.
- **Feature**: Created Docker-based Python PDF extraction system: `scripts/extract-pdf-docker/` with Dockerfile, Python script using PyMuPDF and pdfplumber libraries, and PowerShell/bash run scripts. Successfully extracted text from LWF.pdf and ESIC State Wise.pdf. Parsed LWF data for 16 states with monthly contribution rates (converted from yearly/half-yearly). Parsed ESIC applicability for all major states. Output saved to `scripts/lwf-extracted.json` and `scripts/esic-extracted.json`. Files: `scripts/extract-pdf-docker/Dockerfile`, `scripts/extract-pdf-docker/extract_pdf_data.py`, `scripts/extract-pdf-docker/run-extract.ps1`, `scripts/extract-pdf-docker/run-extract.sh`.
- **Feature**: Updated state tax mappings with extracted LWF and ESIC data: populated `LWF_BY_STATE` with 16 states' contribution rates (preserving per-deduction amounts for half-yearly/yearly, not monthly averages); updated `ESIC_BY_STATE` with applicability status for all states; added `getLWFForMonth()` function to handle month-specific LWF deductions (e.g., half-yearly in June/December only); updated salary calculator to extract month from DOJ for accurate LWF and Professional Tax calculations. Files: `lib/stateTaxMappings.ts`, `lib/salaryCalculator.ts`, `app/api/calculate-salary/route.ts`, `components/OfferLetterForm.tsx`.
- **Feature**: Added "Letter of Engagement with our Clients/Business Partners" section as a new page (Page 4) in the offer letter PDF. Includes all 16 numbered clauses covering Work Assignment terms, intellectual property, confidentiality, termination, dispute resolution, and other engagement terms. Matches reference document word-for-word. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Increased line spacing in the Letter of Engagement section: changed paragraph lineHeight from 1.4 to 1.6 and marginBottom from 6 to 8 for better readability and to match reference document spacing. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Increased spacing for Offer Letter pages 2–3 content (Sections 3–9): updated `listItem` spacing (lineHeight 1.4→1.55, marginBottom 4→6) to better match reference PDF readability. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Fixed Next.js build type error in bulk ZIP download: converted ZIP output from Node `Buffer` to `Uint8Array` before passing to `NextResponse` (TS requires `BodyInit`). Files: `app/api/bulk-generate/route.ts`.
- **Feature**: Populated real LWF + ESIC mappings in `lib/stateTaxMappings.ts` using the extracted documents. LWF now supports **month-aware** deduction via `getLWFForMonth()` (monthly vs Jun/Dec half-yearly vs Dec yearly), and salary calc now passes a `month` option through to both Professional Tax and LWF lookups. Files: `lib/stateTaxMappings.ts`, `lib/salaryCalculator.ts`.
- **Fix**: Aligned signature sections to match SS2 layout: updated signature blocks to use separate left/right styles (`signatureBlockLeft` and `signatureBlockRight`) with proper alignment; left side contains "Warm Regards", company name, signature image, and "Authorised Signatury"; right side contains acceptance text, signature line, and employee name. Updated footer positioning to use absolute positioning at bottom of each page (bottom: 20px). Files: `lib/pdfGenerator.tsx`.
- **Fix**: Removed the unexpected blank “3rd page” caused by `react-pdf` auto-wrapping: disabled wrapping (`wrap={false}`) on the Offer Letter pages that must stay single-page, and made the top bar/header/footer `fixed` so they repeat correctly on any auto-wrapped pages (e.g., Letter of Engagement). Also reserved page padding for fixed header/footer to prevent overlap. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Adjusted signature column layout so the employee name aligns on the same baseline as “Authorised Signatury” (SS2): made both signature columns equal height (`minHeight`) and used `justifyContent: 'space-between'` with a bottom label style. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Matched SS1 bolding + capitalization rules: made key dynamic fields (employee name, client/company name, offer ID, location, designation, and dates) render in **ALL CAPS**, and bolded the meta values (Dear/Date/Ref/Offer ID) to match the reference screenshots. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Matched CTC table styling to reference screenshot: black gridlines, white header background, larger cell padding/row height, table font size alignment, centered numeric columns, and bold only for summary rows (A/B/Net/C/CTC). Also switched table numbers to no-comma formatting to match the screenshot. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Moved employee signature line (`_______________________`) down to the bottom block (directly above the employee name) so it aligns visually with the left “Authorised Signatury” baseline. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Made the full meta header rows (“Dear/Date/Ref/Offer ID”) bold end-to-end to match the reference styling. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Increased the “boldness” of the meta header rows by switching them to `Helvetica-Bold` and slightly increasing font size for stronger emphasis. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Tried “ExtraBold” effect for meta header rows by using the heaviest supported weight (`900`) with `Helvetica-Bold` plus slight letterSpacing to increase ink density. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Normalized meta header font size back to 11pt (kept heavy/bold), and made all user-entered fields render bold throughout the letter (excluding the salary table’s normal rows). Files: `lib/pdfGenerator.tsx`.
- **Fix**: Made the document title (“Offer of Employment”) heavier/bolder by using `Helvetica-Bold` with weight `900`. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Removed large blank gap on the Letter of Engagement page by splitting Clause #4 into multiple `<Text>` blocks so `react-pdf` can paginate it naturally instead of pushing the entire clause to the next page. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Prevented the signature section from splitting across pages by setting `wrap={false}` on the signature container; if it doesn’t fit, the entire block moves to the next page instead of leaving partial “Warm Regards” on the previous page. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Adjusted header spacing and page padding so pages feel “normal” (full-height content area): added white space above the blue header bar and reduced reserved top/bottom padding while still keeping header/footer fixed. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Removed extra white gap above the blue header bar (bar is flush to top again) and added a small spacer on Offer Letter page 3 (Sections 8–9) to improve vertical balance before the signature block. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Slightly reduced CTC table size (font + padding) and added the repeated bold header row at the bottom to match SS2. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Expanded the "Location (State)" dropdown to include missing Union Territories (e.g., Chandigarh) and added a note clarifying that LWF/PT can be month-specific and we use DOJ month for those rules. Files: `components/OfferLetterForm.tsx`.
- **Fix**: Updated LWF data with corrected values from user-provided table: all states now use monthly deduction frequency (removed half-yearly/yearly), and Employer LWF values are set to exact amounts (not calculated as 2X). Updated form note to reflect monthly LWF deduction. Files: `lib/stateTaxMappings.ts`, `components/OfferLetterForm.tsx`.
- **Feature**: Hid phone number and email input fields (temporarily), separated location into two fields: "Location (State for LWF)" dropdown for state selection (used for tax calculations) and "Location (City)" autocomplete field with comprehensive Indian cities list. City field allows typing and shows matching options in dropdown. Updated PDF generator to use city location. Also updated bulk import pages and API routes to support new location fields while maintaining backward compatibility with legacy "location" field. Files: `components/OfferLetterForm.tsx`, `lib/indianCities.ts`, `lib/pdfGenerator.tsx`, `app/bulk/page.tsx`, `app/api/bulk-generate/route.ts`.
- **Verification**: Confirmed that the offer letter PDF always uses the city name (`locationCity`) in the offer letter text, never the state name. The state name (`locationState`) is only used internally for tax calculations (LWF/PT/ESIC). Added clarifying comment in PDF generator. Files: `lib/pdfGenerator.tsx`.
- **Fix**: Fixed build error caused by missing `form-row` wrapper around DOJ and DOO fields. Wrapped both fields in a proper `form-row` div to match the form structure. Files: `components/OfferLetterForm.tsx`.
- **Feature**: Converted Location (City) field to a native searchable dropdown using HTML5 `<datalist>` element. Users can now type to search and select from a dropdown list of Indian cities. Added validation to ensure only valid cities from the list are accepted. Files: `components/OfferLetterForm.tsx`.
- **Fix**: Resolved webpack module loading error (`Cannot find module './638.js'`) by clearing the `.next` build cache folder. This error typically occurs when webpack chunks become corrupted or stale. Files: `.next/` (deleted and regenerated).
- **UI**: Changed "Location (City)" to a **searchable dropdown** using native `<datalist>` so users type to search and pick a city from suggestions; added on-blur validation to ensure the city is selected from the list and normalized casing to the canonical city name. Files: `components/OfferLetterForm.tsx`.